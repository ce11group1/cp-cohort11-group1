graph TB
    subgraph "AWS Cloud (us-east-1)"
        
        subgraph "VPC"
            direction TB
            
            subgraph "Public Subnets"
                ALB[("Application Load Balancer<br/>(Shared ALB)")]
                
                subgraph "ECS Cluster: iot-factory-cluster"
                    subgraph "Fargate Task: iot-simulator-task"
                        direction TB
                        
                        INIT[("Init Container<br/>(AWS CLI)<br/>Downloads Certs & Configs")]
                        
                        APP[("App Container<br/>(Python Simulator)<br/>Gen Data & Metrics")]
                        PROM[("Prometheus Container<br/>Scrapes :9100<br/>Stores Metrics")]
                        GRAF[("Grafana Container<br/>Visualizes :9090")]
                        
                        %% Container Interactions
                        INIT -->|Populates| VOL_CONF[Shared Volume: Configs]
                        INIT -->|Populates| VOL_CERT[Shared Volume: Certs]
                        APP -->|Reads| VOL_CERT
                        PROM -->|Scrapes :9100| APP
                        GRAF -->|Queries :9090| PROM
                        GRAF -->|Reads| VOL_CONF
                    end
                end
            end
        end

        %% External Access
        User((User/Dev)) -->|HTTP:80 -> 3000| ALB
        ALB -->|Forward| GRAF
        ALB -->|Forward /prometheus| PROM

        %% IoT Flow
        APP -->|MQTT TLS: 8883| IOT_CORE["AWS IoT Core"]
        
        %% Rules Engine
        IOT_CORE -->|Rule: SELECT *| IOT_RULE("IoT Topic Rule")
        IOT_RULE -->|Action: PutObject| S3_DATA[("S3 Bucket<br/>Telemetry Data")]
        IOT_RULE -->|Logs| CW_LOGS("CloudWatch Logs")

        %% S3 Config Access
        S3_CONF[("S3 Bucket<br/>Config & Certs")]
        INIT -.->|Pull Files| S3_CONF
        
        %% Secrets
        SECRETS("Secrets Manager<br/>(Grafana SMTP)")
        GRAF -.->|Read SMTP Creds| SECRETS
        
        %% Docker Image
        ECR("ECR Repository")
        ECS_EXEC("Execution Role") -.->|Pull Image| ECR

    end

    classDef aws fill:#FF9900,stroke:#232F3E,color:white;
    classDef container fill:#326CE5,stroke:#232F3E,color:white;
    classDef storage fill:#3F8624,stroke:#232F3E,color:white;
    
    class IOT_CORE,IOT_RULE,ECR,ECS_EXEC aws;
    class APP,PROM,GRAF,INIT container;
    class S3_DATA,S3_CONF,SECRETS,CW_LOGS storage;